{% extends 'base.html.twig' %}

{% block title %}Codes de secours 2FA{% endblock %}

{% block page_title %}
<h1 class="h2 mb-3">
    <i class="fas fa-code text-success me-2"></i>
    {% if regenerated is defined and regenerated %}
        Nouveaux codes de secours
    {% else %}
        Codes de secours générés
    {% endif %}
</h1>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header bg-success text-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-shield-alt me-2"></i>
                    {% if regenerated is defined and regenerated %}
                        2FA activée avec succès !
                    {% else %}
                        Authentification à deux facteurs configurée
                    {% endif %}
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Important !</h6>
                    <p class="mb-0">
                        Sauvegardez ces codes de secours dans un endroit sûr. Ils vous permettront d'accéder à votre compte 
                        si vous perdez votre téléphone ou votre application d'authentification.
                    </p>
                </div>

                <div class="row">
                    <div class="col-md-8 mx-auto">
                        <div class="card bg-light">
                            <div class="card-header">
                                <h6 class="mb-0">
                                    <i class="fas fa-list me-2"></i>
                                    Vos codes de secours
                                    <button class="btn btn-sm btn-outline-primary float-end" onclick="printCodes()">
                                        <i class="fas fa-print me-1"></i>
                                        Imprimer
                                    </button>
                                </h6>
                            </div>
                            <div class="card-body" id="backup-codes">
                                <div class="row">
                                    {% for code in backup_codes %}
                                        <div class="col-md-6 mb-2">
                                            <div class="input-group">
                                                <span class="input-group-text">{{ loop.index }}</span>
                                                <input type="text" class="form-control font-monospace" 
                                                       value="{{ code }}" readonly>
                                                <button class="btn btn-outline-secondary btn-sm" 
                                                        onclick="copyToClipboard('{{ code }}')" 
                                                        title="Copier">
                                                    <i class="fas fa-copy"></i>
                                                </button>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="alert alert-info mt-4">
                    <h6><i class="fas fa-info-circle me-2"></i>Comment utiliser ces codes ?</h6>
                    <ul class="mb-0">
                        <li>Chaque code ne peut être utilisé qu'une seule fois</li>
                        <li>Utilisez un code quand vous n'avez pas accès à votre application d'authentification</li>
                        <li>Générez de nouveaux codes quand il n'en reste plus</li>
                        <li>Gardez ces codes en sécurité et ne les partagez avec personne</li>
                    </ul>
                </div>

                <div class="text-center mt-4">
                    <a href="{{ path('user_security_index') }}" class="btn btn-primary">
                        <i class="fas fa-check me-1"></i>
                        J'ai sauvegardé mes codes
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Version imprimable cachée -->
<div id="printable-codes" class="d-none">
    <h2>Codes de secours - Authentification à deux facteurs</h2>
    <p><strong>Compte :</strong> {{ user.email }}</p>
    <p><strong>Généré le :</strong> {{ "now"|date("d/m/Y à H:i") }}</p>
    
    <h3>Codes de secours :</h3>
    <ol style="font-family: monospace; font-size: 14px; line-height: 2;">
        {% for code in backup_codes %}
            <li>{{ code }}</li>
        {% endfor %}
    </ol>
    
    <div style="margin-top: 30px; padding: 15px; border: 1px solid #ccc; background-color: #f9f9f9;">
        <h4>Instructions importantes :</h4>
        <ul>
            <li>Conservez cette liste dans un endroit sûr et accessible</li>
            <li>Chaque code ne peut être utilisé qu'une seule fois</li>
            <li>Utilisez un code quand vous n'avez pas accès à votre application d'authentification</li>
            <li>Générez de nouveaux codes quand il n'en reste plus</li>
            <li>Ne partagez jamais ces codes avec qui que ce soit</li>
        </ul>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        // Feedback visuel
        const button = event.target.closest('button');
        const originalContent = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check text-success"></i>';
        
        setTimeout(function() {
            button.innerHTML = originalContent;
        }, 1500);
    }).catch(function(err) {
        console.error('Erreur lors de la copie: ', err);
    });
}

function printCodes() {
    const printContent = document.getElementById('printable-codes').innerHTML;
    const originalContent = document.body.innerHTML;
    
    document.body.innerHTML = printContent;
    window.print();
    document.body.innerHTML = originalContent;
    
    // Recharger la page pour restaurer les événements JS
    location.reload();
}

// Avertissement avant fermeture si les codes n'ont pas été sauvegardés
let codesSaved = false;

document.querySelector('a[href*="user_security_index"]').addEventListener('click', function() {
    codesSaved = true;
});

window.addEventListener('beforeunload', function(e) {
    if (!codesSaved) {
        e.preventDefault();
        e.returnValue = 'Avez-vous sauvegardé vos codes de secours ?';
        return 'Avez-vous sauvegardé vos codes de secours ?';
    }
});
</script>
{% endblock %}