{% extends 'admin/base.html.twig' %}

{% block title %}Gestion des demandes de prêt{% endblock %}

{% block admin_content %}
    <div class="admin-header">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <h1>Demandes de prêt</h1>
                <p class="admin-subtitle">Gestion et traitement des demandes</p>
            </div>
            <div class="col-lg-6">
                <div class="admin-actions">
                    <a href="{{ path('admin_loan_applications_stats') }}" class="btn btn-outline-primary">
                        <i class="fa fa-chart-bar"></i> Statistiques
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="row">
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card stat-card--primary">
                    <div class="stat-card__icon">
                        <i class="fa fa-file-alt"></i>
                    </div>
                    <div class="stat-card__content">
                        <h3>{{ stats.total }}</h3>
                        <p>Total</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card stat-card--warning">
                    <div class="stat-card__icon">
                        <i class="fa fa-clock"></i>
                    </div>
                    <div class="stat-card__content">
                        <h3>{{ stats.pending }}</h3>
                        <p>En attente</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card stat-card--info">
                    <div class="stat-card__icon">
                        <i class="fa fa-search"></i>
                    </div>
                    <div class="stat-card__content">
                        <h3>{{ stats.under_review }}</h3>
                        <p>En étude</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card stat-card--success">
                    <div class="stat-card__icon">
                        <i class="fa fa-check"></i>
                    </div>
                    <div class="stat-card__content">
                        <h3>{{ stats.approved }}</h3>
                        <p>Approuvées</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card stat-card--danger">
                    <div class="stat-card__icon">
                        <i class="fa fa-times"></i>
                    </div>
                    <div class="stat-card__content">
                        <h3>{{ stats.rejected }}</h3>
                        <p>Rejetées</p>
                    </div>
                </div>
            </div>
            <div class="col-lg-2 col-md-4 col-sm-6">
                <div class="stat-card stat-card--secondary">
                    <div class="stat-card__icon">
                        <i class="fa fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-card__content">
                        <h3>{{ stats.disbursed }}</h3>
                        <p>Débloquées</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="admin-filters">
        <form method="GET" class="filters-form">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="status">Statut</label>
                    <select name="status" id="status" class="form-select">
                        <option value="all" {{ current_status == 'all' ? 'selected' : '' }}>Tous les statuts</option>
                        <option value="SUBMITTED" {{ current_status == 'SUBMITTED' ? 'selected' : '' }}>Soumises</option>
                        <option value="UNDER_REVIEW" {{ current_status == 'UNDER_REVIEW' ? 'selected' : '' }}>En étude</option>
                        <option value="APPROVED" {{ current_status == 'APPROVED' ? 'selected' : '' }}>Approuvées</option>
                        <option value="REJECTED" {{ current_status == 'REJECTED' ? 'selected' : '' }}>Rejetées</option>
                        <option value="DISBURSED" {{ current_status == 'DISBURSED' ? 'selected' : '' }}>Débloquées</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="search">Recherche</label>
                    <input type="text" name="search" id="search" class="form-control" 
                           placeholder="Nom, email, type de prêt..." value="{{ search }}">
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fa fa-search"></i> Filtrer
                    </button>
                </div>
                <div class="col-md-2">
                    <a href="{{ path('admin_loan_applications_index') }}" class="btn btn-outline-secondary w-100">
                        <i class="fa fa-times"></i> Réinitialiser
                    </a>
                </div>
            </div>
        </form>
    </div>

    <!-- Applications Table -->
    <div class="admin-table-container">
        {% if applications|length > 0 %}
            <div class="table-responsive">
                <table class="table admin-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Client</th>
                            <th>Type de prêt</th>
                            <th>Montant</th>
                            <th>Durée</th>
                            <th>Statut</th>
                            <th>Date soumission</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for application in applications %}
                            <tr class="application-row" data-status="{{ application.status|lower }}">
                                <td>
                                    <strong>#{{ application.id }}</strong>
                                </td>
                                <td>
                                    <div class="client-info">
                                        <div class="client-name">
                                            {{ application.user.firstName ?? 'N/A' }} {{ application.user.lastName ?? '' }}
                                        </div>
                                        <div class="client-email">{{ application.user.email }}</div>
                                        <div class="client-type">
                                            <span class="badge badge-outline-{{ application.user.accountType == 'BUSINESS' ? 'info' : 'secondary' }}">
                                                {{ application.user.accountType == 'BUSINESS' ? 'Entreprise' : 'Particulier' }}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <strong>{{ application.loanType.name }}</strong>
                                </td>
                                <td>
                                    <span class="amount">{{ application.requestedAmount|number_format(0, ',', ' ') }}€</span>
                                </td>
                                <td>
                                    {{ application.duration }} mois
                                </td>
                                <td>
                                    <span class="badge badge-{{ application.status|lower|replace({'_': '-'}) }}">
                                        {% if application.status == 'SUBMITTED' %}
                                            Soumise
                                        {% elseif application.status == 'UNDER_REVIEW' %}
                                            En étude
                                        {% elseif application.status == 'APPROVED' %}
                                            Approuvée
                                        {% elseif application.status == 'REJECTED' %}
                                            Rejetée
                                        {% elseif application.status == 'DISBURSED' %}
                                            Débloquée
                                        {% else %}
                                            {{ application.status }}
                                        {% endif %}
                                    </span>
                                </td>
                                <td>
                                    {% if application.submittedAt %}
                                        <div class="date">{{ application.submittedAt|date('d/m/Y') }}</div>
                                        <div class="time">{{ application.submittedAt|date('H:i') }}</div>
                                    {% else %}
                                        <span class="text-muted">N/A</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="action-buttons">
                                        <a href="{{ path('admin_loan_application_detail', {id: application.id}) }}" 
                                           class="btn btn-sm btn-outline-primary" title="Voir détails">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                        {% if application.status in ['SUBMITTED', 'UNDER_REVIEW'] %}
                                            <a href="{{ path('admin_loan_application_review', {id: application.id}) }}" 
                                               class="btn btn-sm btn-outline-success" title="Traiter">
                                                <i class="fa fa-gavel"></i>
                                            </a>
                                        {% endif %}
                                        <a href="{{ path('admin_loan_application_documents', {id: application.id}) }}" 
                                           class="btn btn-sm btn-outline-info" title="Documents">
                                            <i class="fa fa-file-alt"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="empty-state">
                <div class="empty-state__icon">
                    <i class="fa fa-search fa-3x text-muted"></i>
                </div>
                <h3>Aucune demande trouvée</h3>
                <p>Aucune demande de prêt ne correspond à vos critères de recherche.</p>
            </div>
        {% endif %}
    </div>
{% endblock %}

{% block admin_stylesheets %}
<style>
.admin-header {
    margin-bottom: 2rem;
}

.admin-subtitle {
    color: #6c757d;
    margin: 0;
}

.admin-actions {
    text-align: right;
}

.stats-grid {
    margin-bottom: 2rem;
}

.stat-card {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1rem;
}

.stat-card--primary { border-left: 4px solid #007bff; }
.stat-card--warning { border-left: 4px solid #ffc107; }
.stat-card--info { border-left: 4px solid #17a2b8; }
.stat-card--success { border-left: 4px solid #28a745; }
.stat-card--danger { border-left: 4px solid #dc3545; }
.stat-card--secondary { border-left: 4px solid #6c757d; }

.stat-card__icon {
    font-size: 2rem;
    opacity: 0.8;
    color: inherit;
}

.stat-card--primary .stat-card__icon { color: #007bff; }
.stat-card--warning .stat-card__icon { color: #ffc107; }
.stat-card--info .stat-card__icon { color: #17a2b8; }
.stat-card--success .stat-card__icon { color: #28a745; }
.stat-card--danger .stat-card__icon { color: #dc3545; }
.stat-card--secondary .stat-card__icon { color: #6c757d; }

.stat-card__content h3 {
    margin: 0;
    font-size: 1.75rem;
    font-weight: bold;
    color: #333;
}

.stat-card__content p {
    margin: 0;
    color: #666;
    font-size: 0.9rem;
}

.admin-filters {
    background: #fff;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.admin-table-container {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    overflow: hidden;
}

.admin-table {
    margin: 0;
}

.admin-table thead th {
    background: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    font-weight: 600;
    color: #495057;
    padding: 1rem 0.75rem;
}

.admin-table tbody td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f4;
}

.client-info {
    min-width: 150px;
}

.client-name {
    font-weight: 600;
    color: #333;
    margin-bottom: 0.25rem;
}

.client-email {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 0.25rem;
}

.client-type {
    margin-top: 0.25rem;
}

.amount {
    font-weight: 600;
    color: #007bff;
    font-size: 1.1rem;
}

.date {
    font-weight: 600;
    color: #333;
}

.time {
    font-size: 0.85rem;
    color: #666;
}

.action-buttons {
    display: flex;
    gap: 0.25rem;
}

.action-buttons .btn {
    padding: 0.375rem 0.5rem;
}

.badge-submitted { background-color: #17a2b8; }
.badge-under-review { background-color: #ffc107; color: #212529; }
.badge-approved { background-color: #28a745; }
.badge-rejected { background-color: #dc3545; }
.badge-disbursed { background-color: #007bff; }

.badge-outline-info { 
    border: 1px solid #17a2b8; 
    color: #17a2b8; 
    background: transparent; 
}

.badge-outline-secondary { 
    border: 1px solid #6c757d; 
    color: #6c757d; 
    background: transparent; 
}

.empty-state {
    text-align: center;
    padding: 4rem 2rem;
}

.empty-state__icon {
    margin-bottom: 2rem;
}

.empty-state h3 {
    color: #333;
    margin-bottom: 1rem;
}

.empty-state p {
    color: #666;
}

/* Row highlighting based on status */
.application-row[data-status="submitted"] {
    background: rgba(23, 162, 184, 0.05);
}

.application-row[data-status="under-review"] {
    background: rgba(255, 193, 7, 0.05);
}

.application-row[data-status="approved"] {
    background: rgba(40, 167, 69, 0.05);
}

.application-row[data-status="rejected"] {
    background: rgba(220, 53, 69, 0.05);
}

@media (max-width: 768px) {
    .stats-grid .col-lg-2 {
        margin-bottom: 1rem;
    }
    
    .admin-actions {
        text-align: left;
        margin-top: 1rem;
    }
    
    .filters-form .row > div {
        margin-bottom: 1rem;
    }
    
    .admin-table {
        font-size: 0.85rem;
    }
    
    .action-buttons {
        flex-direction: column;
    }
}
</style>
{% endblock %}