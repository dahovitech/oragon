{% extends 'base.html.twig' %}

{% block title %}Gestion des PrÃªts - Admin - EdgeLoan{% endblock %}

{% block page_header %}
    <div class="page-header">
        <div class="row align-items-center">
            <div class="col">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{{ path('app_admin_dashboard') }}">Admin</a></li>
                        <li class="breadcrumb-item active" aria-current="page">PrÃªts</li>
                    </ol>
                </nav>
                <h1 class="page-title">ðŸ’° Gestion des Demandes de PrÃªt</h1>
                <div class="page-subtitle">{{ loan_applications|length }} demandes au total</div>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary" data-bs-toggle="modal" data-bs-target="#filterLoanModal">
                        <i class="fas fa-filter"></i> Filtrer
                    </button>
                    <button type="button" class="btn btn-outline-success" onclick="exportLoans()">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                    <div class="btn-group" role="group">
                        <button type="button" class="btn btn-outline-info dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-chart-bar"></i> Rapports
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/reports/loans/monthly">Rapport mensuel</a></li>
                            <li><a class="dropdown-item" href="/admin/reports/loans/performance">Performance</a></li>
                            <li><a class="dropdown-item" href="/admin/reports/loans/risk-analysis">Analyse des risques</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block body %}
<div class="container-xl">
    
    {# Statistiques des prÃªts #}
    <div class="row mb-4">
        <div class="col-sm-6 col-lg-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="subheader">En attente</div>
                        <div class="ms-auto lh-1">
                            <i class="fas fa-clock text-warning"></i>
                        </div>
                    </div>
                    {% set pending_count = 0 %}
                    {% for loan in loan_applications if loan.status == 'pending' %}
                        {% set pending_count = pending_count + 1 %}
                    {% endfor %}
                    <div class="h1 mb-0">{{ pending_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="subheader">ApprouvÃ©s</div>
                        <div class="ms-auto lh-1">
                            <i class="fas fa-check-circle text-success"></i>
                        </div>
                    </div>
                    {% set approved_count = 0 %}
                    {% set approved_amount = 0 %}
                    {% for loan in loan_applications if loan.status == 'approved' %}
                        {% set approved_count = approved_count + 1 %}
                        {% set approved_amount = approved_amount + loan.amount %}
                    {% endfor %}
                    <div class="h1 mb-0">{{ approved_count }}</div>
                    <div class="text-muted small">{{ approved_amount|number_format(0, ',', ' ') }}â‚¬</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="subheader">RejetÃ©s</div>
                        <div class="ms-auto lh-1">
                            <i class="fas fa-times-circle text-danger"></i>
                        </div>
                    </div>
                    {% set rejected_count = 0 %}
                    {% for loan in loan_applications if loan.status == 'rejected' %}
                        {% set rejected_count = rejected_count + 1 %}
                    {% endfor %}
                    <div class="h1 mb-0">{{ rejected_count }}</div>
                </div>
            </div>
        </div>
        <div class="col-sm-6 col-lg-3 mb-3">
            <div class="card">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="subheader">Montant total</div>
                        <div class="ms-auto lh-1">
                            <i class="fas fa-euro-sign text-primary"></i>
                        </div>
                    </div>
                    {% set total_amount = 0 %}
                    {% for loan in loan_applications %}
                        {% set total_amount = total_amount + loan.amount %}
                    {% endfor %}
                    <div class="h1 mb-0">{{ (total_amount / 1000)|number_format(0) }}Kâ‚¬</div>
                    <div class="text-muted small">{{ total_amount|number_format(0, ',', ' ') }}â‚¬</div>
                </div>
            </div>
        </div>
    </div>

    {# Actions prioritaires #}
    {% if pending_count > 0 %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-warning" role="alert">
                <div class="d-flex align-items-center">
                    <div class="flex-fill">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>{{ pending_count }} demande(s) de prÃªt en attente</strong> nÃ©cessitent une Ã©valuation.
                        Temps de traitement moyen recommandÃ© : 24-48h.
                    </div>
                    <div>
                        <button class="btn btn-warning btn-sm" onclick="processPendingLoans()">
                            Traiter maintenant
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {# Table des demandes de prÃªt #}
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">ðŸ“‹ Demandes de PrÃªt</h3>
                    <div class="card-actions">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="Rechercher..." id="searchLoans">
                            <button class="btn btn-outline-primary" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-vcenter" id="loansTable">
                            <thead>
                                <tr>
                                    <th>Demandeur</th>
                                    <th>Montant</th>
                                    <th>DurÃ©e</th>
                                    <th>But du prÃªt</th>
                                    <th>Statut</th>
                                    <th>Score de risque</th>
                                    <th>Soumise le</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for application in loan_applications %}
                                <tr class="loan-row" data-loan-id="{{ application.id }}" data-status="{{ application.status }}">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <span class="avatar me-2 rounded" style="background-image: url({{ asset('img/default-avatar.png') }})"></span>
                                            <div>
                                                <div class="font-weight-medium">
                                                    {{ application.user.firstName }} {{ application.user.lastName }}
                                                    {% if application.user.accountType.value == 'business' %}
                                                        <span class="badge bg-warning ms-1">PRO</span>
                                                    {% endif %}
                                                </div>
                                                <div class="text-muted small">
                                                    {{ application.user.email }}
                                                    {% if application.user.isVerified %}
                                                        <i class="fas fa-check-circle text-success ms-1" title="KYC vÃ©rifiÃ©"></i>
                                                    {% else %}
                                                        <i class="fas fa-exclamation-triangle text-warning ms-1" title="KYC non vÃ©rifiÃ©"></i>
                                                    {% endif %}
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="font-weight-medium">{{ application.amount|number_format(0, ',', ' ') }}â‚¬</div>
                                        {% if application.interestRate %}
                                            <div class="text-muted small">Taux: {{ application.interestRate }}%</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark">{{ application.duration }} mois</span>
                                        {% if application.monthlyPayment %}
                                            <div class="text-muted small">{{ application.monthlyPayment|number_format(0) }}â‚¬/mois</div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="font-weight-medium">{{ application.purpose }}</div>
                                        {% if application.description %}
                                            <div class="text-muted small text-truncate" style="max-width: 150px;">
                                                {{ application.description }}
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge {{ application.statusBadgeClass }}">
                                            {{ application.statusLabel }}
                                        </span>
                                        {% set days_ago = date().diff(application.submittedAt).days %}
                                        {% if application.status == 'pending' and days_ago > 2 %}
                                            <div class="text-danger small">
                                                <i class="fas fa-clock"></i> {{ days_ago }}j
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% set risk_score = application.riskScore|default(0) %}
                                        {% if risk_score <= 30 %}
                                            <span class="badge bg-success">Faible ({{ risk_score }})</span>
                                        {% elseif risk_score <= 60 %}
                                            <span class="badge bg-warning">Moyen ({{ risk_score }})</span>
                                        {% else %}
                                            <span class="badge bg-danger">Ã‰levÃ© ({{ risk_score }})</span>
                                        {% endif %}
                                        <div class="progress progress-xs mt-1">
                                            <div class="progress-bar 
                                                {% if risk_score <= 30 %}bg-success
                                                {% elseif risk_score <= 60 %}bg-warning
                                                {% else %}bg-danger{% endif %}" 
                                                style="width: {{ risk_score }}%"></div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="text-muted">{{ application.submittedAt|date('d/m/Y') }}</div>
                                        <div class="text-muted small">{{ application.submittedAt|date('H:i') }}</div>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-outline-info" 
                                                    title="Voir dÃ©tails"
                                                    onclick="viewLoanDetails({{ application.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            {% if application.status == 'pending' %}
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-gavel"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item text-success" href="#" 
                                                           onclick="approveLoan({{ application.id }})">
                                                            <i class="fas fa-check me-1"></i> Approuver
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item text-warning" href="#" 
                                                           onclick="requestDocuments({{ application.id }})">
                                                            <i class="fas fa-file-alt me-1"></i> Demander documents
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item text-danger" href="#" 
                                                           onclick="rejectLoan({{ application.id }})">
                                                            <i class="fas fa-times me-1"></i> Rejeter
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                            {% endif %}
                                            <div class="btn-group btn-group-sm" role="group">
                                                <button type="button" class="btn btn-outline-secondary dropdown-toggle" 
                                                        data-bs-toggle="dropdown" aria-expanded="false">
                                                    <i class="fas fa-ellipsis-v"></i>
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li>
                                                        <a class="dropdown-item" href="#" 
                                                           onclick="sendEmailToApplicant({{ application.id }})">
                                                            <i class="fas fa-envelope me-1"></i> Envoyer email
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#" 
                                                           onclick="viewApplicantProfile({{ application.user.id }})">
                                                            <i class="fas fa-user me-1"></i> Profil demandeur
                                                        </a>
                                                    </li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           onclick="generateContract({{ application.id }})">
                                                            <i class="fas fa-file-contract me-1"></i> GÃ©nÃ©rer contrat
                                                        </a>
                                                    </li>
                                                    <li><hr class="dropdown-divider"></li>
                                                    <li>
                                                        <a class="dropdown-item" href="#"
                                                           onclick="exportLoanDetails({{ application.id }})">
                                                            <i class="fas fa-download me-1"></i> Exporter dÃ©tails
                                                        </a>
                                                    </li>
                                                </ul>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="card-footer">
                    <div class="row align-items-center">
                        <div class="col">
                            <small class="text-muted">
                                Affichage de {{ loan_applications|length }} demandes 
                                â€¢ Total: {{ total_amount|number_format(0, ',', ' ') }}â‚¬
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{# Modal de filtrage des prÃªts #}
<div class="modal fade" id="filterLoanModal" tabindex="-1" aria-labelledby="filterLoanModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="filterLoanModalLabel">Filtres AvancÃ©s - PrÃªts</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body">
                <form id="filterLoanForm">
                    <div class="mb-3">
                        <label for="statusLoanFilter" class="form-label">Statut</label>
                        <select class="form-select" id="statusLoanFilter">
                            <option value="">Tous les statuts</option>
                            <option value="pending">En attente</option>
                            <option value="approved">ApprouvÃ©s</option>
                            <option value="rejected">RejetÃ©s</option>
                            <option value="under_review">En cours d'examen</option>
                        </select>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amountMinFilter" class="form-label">Montant minimum</label>
                                <input type="number" class="form-control" id="amountMinFilter" placeholder="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="amountMaxFilter" class="form-label">Montant maximum</label>
                                <input type="number" class="form-control" id="amountMaxFilter" placeholder="100000">
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="riskScoreFilter" class="form-label">Score de risque</label>
                        <select class="form-select" id="riskScoreFilter">
                            <option value="">Tous les risques</option>
                            <option value="low">Faible (0-30)</option>
                            <option value="medium">Moyen (31-60)</option>
                            <option value="high">Ã‰levÃ© (61+)</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="purposeFilter" class="form-label">But du prÃªt</label>
                        <select class="form-select" id="purposeFilter">
                            <option value="">Tous les buts</option>
                            <option value="personal">Personnel</option>
                            <option value="business">Professionnel</option>
                            <option value="real_estate">Immobilier</option>
                            <option value="vehicle">VÃ©hicule</option>
                            <option value="education">Ã‰ducation</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="submissionDateFilter" class="form-label">Soumise depuis</label>
                        <select class="form-select" id="submissionDateFilter">
                            <option value="">Toutes les dates</option>
                            <option value="today">Aujourd'hui</option>
                            <option value="week">Cette semaine</option>
                            <option value="month">Ce mois</option>
                            <option value="year">Cette annÃ©e</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="clearLoanFilters()">Effacer</button>
                <button type="button" class="btn btn-primary" onclick="applyLoanFilters()">Appliquer</button>
            </div>
        </div>
    </div>
</div>

{# Modal de dÃ©tails du prÃªt #}
<div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-labelledby="loanDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="loanDetailsModalLabel">DÃ©tails de la Demande de PrÃªt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
            </div>
            <div class="modal-body" id="loanDetailsContent">
                <!-- Le contenu sera chargÃ© dynamiquement -->
            </div>
        </div>
    </div>
</div>

<script>
// Fonctions JavaScript pour la gestion des prÃªts
function viewLoanDetails(loanId) {
    fetch(`/admin/loans/${loanId}/details`)
        .then(response => response.text())
        .then(html => {
            document.getElementById('loanDetailsContent').innerHTML = html;
            new bootstrap.Modal(document.getElementById('loanDetailsModal')).show();
        });
}

function approveLoan(loanId) {
    if (confirm('Approuver cette demande de prÃªt ?')) {
        fetch(`/admin/loans/${loanId}/approve`, {method: 'POST'})
            .then(response => {
                if (response.ok) {
                    location.reload();
                    showNotification('PrÃªt approuvÃ© avec succÃ¨s', 'success');
                }
            });
    }
}

function rejectLoan(loanId) {
    const reason = prompt('Raison du rejet (obligatoire):');
    if (reason && reason.trim()) {
        fetch(`/admin/loans/${loanId}/reject`, {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({reason: reason})
        }).then(response => {
            if (response.ok) {
                location.reload();
                showNotification('PrÃªt rejetÃ©', 'warning');
            }
        });
    }
}

function requestDocuments(loanId) {
    if (confirm('Demander des documents supplÃ©mentaires ?')) {
        fetch(`/admin/loans/${loanId}/request-documents`, {method: 'POST'})
            .then(response => {
                if (response.ok) {
                    location.reload();
                    showNotification('Demande de documents envoyÃ©e', 'info');
                }
            });
    }
}

function generateContract(loanId) {
    window.location.href = `/admin/loans/${loanId}/generate-contract`;
}

function exportLoans() {
    window.location.href = '/admin/loans/export';
}

function processPendingLoans() {
    // Filtrer pour afficher seulement les prÃªts en attente
    document.getElementById('statusLoanFilter').value = 'pending';
    applyLoanFilters();
}

// Recherche en temps rÃ©el
document.getElementById('searchLoans').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('#loansTable tbody .loan-row');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(searchTerm) ? '' : 'none';
    });
});

// Filtres
function applyLoanFilters() {
    const statusFilter = document.getElementById('statusLoanFilter').value;
    const amountMin = document.getElementById('amountMinFilter').value;
    const amountMax = document.getElementById('amountMaxFilter').value;
    const riskFilter = document.getElementById('riskScoreFilter').value;
    const purposeFilter = document.getElementById('purposeFilter').value;
    
    const rows = document.querySelectorAll('#loansTable tbody .loan-row');
    
    rows.forEach(row => {
        let visible = true;
        
        // Filtrer par statut
        if (statusFilter && row.dataset.status !== statusFilter) {
            visible = false;
        }
        
        // Autres filtres...
        
        row.style.display = visible ? '' : 'none';
    });
    
    bootstrap.Modal.getInstance(document.getElementById('filterLoanModal')).hide();
}

function clearLoanFilters() {
    document.getElementById('filterLoanForm').reset();
    const rows = document.querySelectorAll('#loansTable tbody .loan-row');
    rows.forEach(row => row.style.display = '');
}

function showNotification(message, type) {
    // Afficher une notification toast
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    toast.style.top = '20px';
    toast.style.right = '20px';
    toast.style.zIndex = '9999';
    toast.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 5000);
}
</script>
{% endblock %}