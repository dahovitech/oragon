{% extends 'frontend/base.html.twig' %}

{% block title %}{{ loanType.name }} - EdgeLoan{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="/assets/vendor/nouislider/distribute/nouislider.min.css">
    <style>
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 80px 0;
        }
        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .feature-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            border: 1px solid #e0e0e0;
        }
        .calculator-widget {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            position: sticky;
            top: 100px;
        }
        .requirement-item {
            background: #f8f9fa;
            border-left: 4px solid #007bff;
            padding: 15px 20px;
            margin: 10px 0;
            border-radius: 0 8px 8px 0;
        }
    </style>
{% endblock %}

{% block body %}
<!-- Hero Section -->
<section class="hero-section">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <nav aria-label="breadcrumb" class="mb-3">
                    <ol class="breadcrumb breadcrumb-white">
                        <li class="breadcrumb-item">
                            <a href="{{ path('app_home') }}" class="text-white">Accueil</a>
                        </li>
                        <li class="breadcrumb-item">
                            <a href="{{ path('app_loan_catalog') }}" class="text-white">Catalogue</a>
                        </li>
                        <li class="breadcrumb-item active text-white-50">{{ loanType.name }}</li>
                    </ol>
                </nav>
                
                <h1 class="display-4 font-weight-bold mb-3">{{ loanType.name }}</h1>
                <p class="lead mb-4">{{ loanType.description }}</p>
                
                <div class="row mb-4">
                    <div class="col-md-4">
                        <h5>Montant</h5>
                        <p class="h4">{{ loanType.minAmount|number_format(0, ',', ' ') }}€ - {{ loanType.maxAmount|number_format(0, ',', ' ') }}€</p>
                    </div>
                    <div class="col-md-4">
                        <h5>Durée</h5>
                        <p class="h4">{{ loanType.minDuration }} - {{ loanType.maxDuration }} mois</p>
                    </div>
                    <div class="col-md-4">
                        <h5>Taux à partir de</h5>
                        <p class="h4 text-warning">{{ loanType.baseInterestRate }}%</p>
                    </div>
                </div>
                
                <!-- Action Buttons -->
                <div class="d-flex gap-3">
                    {% if canApply %}
                        <a href="{{ path('app_loan_application_new', {'loanType': loanType.id}) }}" 
                           class="btn btn-warning btn-lg">
                            <i class="fas fa-paper-plane me-2"></i>Faire une demande
                        </a>
                    {% else %}
                        {% if user %}
                            <button class="btn btn-secondary btn-lg" disabled>
                                <i class="fas fa-lock me-2"></i>Compte non vérifié
                            </button>
                            <a href="{{ path('app_verification_index') }}" class="btn btn-outline-light btn-lg">
                                <i class="fas fa-shield-alt me-2"></i>Vérifier mon compte
                            </a>
                        {% else %}
                            <a href="{{ path('app_login') }}" class="btn btn-warning btn-lg">
                                <i class="fas fa-sign-in-alt me-2"></i>Se connecter pour demander
                            </a>
                        {% endif %}
                    {% endif %}
                    
                    <a href="#calculator" class="btn btn-outline-light btn-lg">
                        <i class="fas fa-calculator me-2"></i>Calculer
                    </a>
                </div>
            </div>
            <div class="col-lg-4 text-center">
                {% if loanType.image %}
                    <img src="{{ loanType.image.path }}" alt="{{ loanType.name }}" 
                         class="img-fluid rounded-3" style="max-height: 300px;">
                {% else %}
                    <div class="bg-white bg-opacity-25 rounded-3 p-5">
                        <i class="fas fa-coins fa-5x text-white opacity-50"></i>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</section>

<div class="container py-5">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Features Section -->
            <section class="mb-5">
                <h2 class="h3 mb-4">
                    <i class="fas fa-star text-warning me-2"></i>
                    Avantages de ce prêt
                </h2>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <i class="fas fa-tachometer-alt fa-2x text-primary mb-3"></i>
                        <h5>Traitement rapide</h5>
                        <p class="text-muted">Réponse sous 48h pour les dossiers complets</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-percentage fa-2x text-success mb-3"></i>
                        <h5>Taux compétitif</h5>
                        <p class="text-muted">À partir de {{ loanType.baseInterestRate }}% selon votre profil</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-handshake fa-2x text-info mb-3"></i>
                        <h5>Accompagnement</h5>
                        <p class="text-muted">Conseiller dédié tout au long du processus</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-shield-alt fa-2x text-warning mb-3"></i>
                        <h5>Sécurisé</h5>
                        <p class="text-muted">Vos données sont protégées et sécurisées</p>
                    </div>
                </div>
            </section>

            <!-- Detailed Description -->
            {% if loanType.longDescription %}
                <section class="mb-5">
                    <h2 class="h3 mb-4">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Description détaillée
                    </h2>
                    <div class="card">
                        <div class="card-body">
                            {{ loanType.longDescription|nl2br }}
                        </div>
                    </div>
                </section>
            {% endif %}

            <!-- Requirements -->
            <section class="mb-5">
                <h2 class="h3 mb-4">
                    <i class="fas fa-clipboard-list text-success me-2"></i>
                    Documents requis
                </h2>
                
                <div class="row">
                    <div class="col-md-6">
                        <h5>Documents généraux</h5>
                        {% for document in loanType.requiredDocuments %}
                            <div class="requirement-item">
                                <i class="fas fa-file-alt text-primary me-2"></i>
                                {{ document }}
                            </div>
                        {% endfor %}
                    </div>
                    <div class="col-md-6">
                        <h5>Conditions d'éligibilité</h5>
                        <div class="requirement-item">
                            <i class="fas fa-user-check text-success me-2"></i>
                            Compte vérifié EdgeLoan
                        </div>
                        {% if 'INDIVIDUAL' in loanType.allowedAccountTypes %}
                            <div class="requirement-item">
                                <i class="fas fa-user text-info me-2"></i>
                                Particulier majeur
                            </div>
                        {% endif %}
                        {% if 'BUSINESS' in loanType.allowedAccountTypes %}
                            <div class="requirement-item">
                                <i class="fas fa-building text-warning me-2"></i>
                                Entreprise en activité
                            </div>
                        {% endif %}
                    </div>
                </div>
            </section>

            <!-- FAQ -->
            <section class="mb-5">
                <h2 class="h3 mb-4">
                    <i class="fas fa-question-circle text-info me-2"></i>
                    Questions fréquentes
                </h2>
                
                <div class="accordion" id="faqAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                                Quel est le délai de traitement ?
                            </button>
                        </h2>
                        <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Le délai de traitement est généralement de 48 à 72 heures pour les dossiers complets. 
                                Une fois votre demande approuvée, les fonds sont versés sous 24 heures.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                                Puis-je rembourser par anticipation ?
                            </button>
                        </h2>
                        <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Oui, vous pouvez rembourser votre prêt par anticipation à tout moment, 
                                partiellement ou totalement, sans frais ni pénalités.
                            </div>
                        </div>
                    </div>
                    
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                                Comment est calculé le taux d'intérêt ?
                            </button>
                        </h2>
                        <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Le taux d'intérêt est calculé en fonction de votre profil de risque, 
                                de vos revenus, de votre historique de crédit et de la durée du prêt.
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <!-- Sidebar Calculator -->
        <div class="col-lg-4">
            <div class="calculator-widget" id="calculator">
                <h4 class="mb-4 text-center">
                    <i class="fas fa-calculator text-primary me-2"></i>
                    Simulateur
                </h4>
                
                <form id="loan-calculator">
                    <div class="mb-3">
                        <label class="form-label">Montant souhaité</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="loan-amount" 
                                   min="{{ loanType.minAmount }}" max="{{ loanType.maxAmount }}"
                                   value="{{ (loanType.minAmount + loanType.maxAmount) / 2 }}">
                            <span class="input-group-text">€</span>
                        </div>
                        <small class="text-muted">
                            Entre {{ loanType.minAmount|number_format(0, ',', ' ') }}€ et {{ loanType.maxAmount|number_format(0, ',', ' ') }}€
                        </small>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">Durée</label>
                        <div id="duration-slider" class="mb-3"></div>
                        <div class="text-center">
                            <span id="duration-value">{{ ((loanType.minDuration + loanType.maxDuration) / 2)|round }}</span> mois
                        </div>
                        <input type="hidden" id="loan-duration" value="{{ ((loanType.minDuration + loanType.maxDuration) / 2)|round }}">
                    </div>
                    
                    <button type="submit" class="btn btn-primary w-100 mb-3">
                        <i class="fas fa-calculator me-2"></i>Calculer
                    </button>
                </form>
                
                <!-- Results -->
                <div id="calculation-results" style="display: none;">
                    <div class="alert alert-light border">
                        <h6 class="mb-3">Résultats de la simulation</h6>
                        <div class="row text-center">
                            <div class="col-12 mb-2">
                                <small class="text-muted d-block">Mensualité</small>
                                <strong class="text-primary h5" id="monthly-payment">-</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Coût total</small>
                                <strong id="total-cost">-</strong>
                            </div>
                            <div class="col-6">
                                <small class="text-muted d-block">Intérêts</small>
                                <strong id="total-interest">-</strong>
                            </div>
                        </div>
                    </div>
                    
                    {% if canApply %}
                        <a href="{{ path('app_loan_application_new', {'loanType': loanType.id}) }}" 
                           class="btn btn-success w-100" id="apply-with-calc">
                            <i class="fas fa-paper-plane me-2"></i>Faire une demande avec ces paramètres
                        </a>
                    {% endif %}
                </div>
            </div>
            
            <!-- Related Loans -->
            <div class="mt-4">
                <h5 class="mb-3">Prêts similaires</h5>
                <!-- Vous pouvez ajouter ici d'autres types de prêts -->
                <div class="alert alert-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>Conseil :</strong> Comparez plusieurs offres pour trouver celle qui vous convient le mieux.
                </div>
                
                <a href="{{ path('app_loan_catalog') }}" class="btn btn-outline-primary w-100">
                    <i class="fas fa-search me-2"></i>Voir tous les prêts
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="/assets/vendor/nouislider/distribute/nouislider.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const durationSlider = document.getElementById('duration-slider');
            const durationValue = document.getElementById('duration-value');
            const durationInput = document.getElementById('loan-duration');
            
            // Initialize duration slider
            noUiSlider.create(durationSlider, {
                start: [{{ ((loanType.minDuration + loanType.maxDuration) / 2)|round }}],
                connect: [true, false],
                range: {
                    'min': {{ loanType.minDuration }},
                    'max': {{ loanType.maxDuration }}
                },
                step: 1,
                format: {
                    to: function(value) {
                        return Math.round(value);
                    },
                    from: function(value) {
                        return Number(value);
                    }
                }
            });

            durationSlider.noUiSlider.on('update', function(values) {
                const value = parseInt(values[0]);
                durationValue.textContent = value;
                durationInput.value = value;
            });

            // Calculator form
            document.getElementById('loan-calculator').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const amount = parseFloat(document.getElementById('loan-amount').value);
                const duration = parseInt(document.getElementById('loan-duration').value);
                
                // Validation
                if (amount < {{ loanType.minAmount }} || amount > {{ loanType.maxAmount }}) {
                    alert('Le montant doit être entre {{ loanType.minAmount|number_format(0, ',', ' ') }}€ et {{ loanType.maxAmount|number_format(0, ',', ' ') }}€');
                    return;
                }
                
                if (duration < {{ loanType.minDuration }} || duration > {{ loanType.maxDuration }}) {
                    alert('La durée doit être entre {{ loanType.minDuration }} et {{ loanType.maxDuration }} mois');
                    return;
                }
                
                // Call calculation API
                fetch('{{ path('app_loan_calculate') }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        amount: amount,
                        duration: duration,
                        loanTypeId: {{ loanType.id }}
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        alert(data.error);
                        return;
                    }
                    
                    // Display results
                    document.getElementById('monthly-payment').textContent = 
                        data.monthlyPayment.toLocaleString('fr-FR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        }) + '€';
                    
                    document.getElementById('total-cost').textContent = 
                        data.totalAmount.toLocaleString('fr-FR', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + '€';
                    
                    document.getElementById('total-interest').textContent = 
                        data.totalInterest.toLocaleString('fr-FR', {
                            minimumFractionDigits: 0,
                            maximumFractionDigits: 0
                        }) + '€';
                    
                    document.getElementById('calculation-results').style.display = 'block';
                    
                    // Update apply link with parameters
                    const applyLink = document.getElementById('apply-with-calc');
                    if (applyLink) {
                        const url = new URL(applyLink.href);
                        url.searchParams.set('amount', amount);
                        url.searchParams.set('duration', duration);
                        applyLink.href = url.toString();
                    }
                })
                .catch(error => {
                    console.error('Erreur:', error);
                    alert('Erreur lors du calcul. Veuillez réessayer.');
                });
            });
        });
    </script>
{% endblock %}