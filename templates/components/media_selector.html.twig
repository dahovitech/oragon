{#
    Composant de sélection de média
    
    Paramètres:
    - selectedMedia: l'objet Media actuellement sélectionné (optionnel)
    - inputName: nom du champ input (par défaut: 'imageId')
    - label: libellé du champ (par défaut: 'Image')
    - required: champ requis ou non (par défaut: false)
#}

{% set inputName = inputName|default('imageId') %}
{% set label = label|default('Image') %}
{% set required = required|default(false) %}

<div class="mb-3">
    <label class="form-label">
        {{ label }}
        {% if required %}<span class="text-danger">*</span>{% endif %}
    </label>
    
    <div class="media-selector" id="mediaSelector_{{ inputName }}">
        <!-- Champ caché pour stocker l'ID du média -->
        <input type="hidden" name="{{ inputName }}" value="{{ selectedMedia ? selectedMedia.id : '' }}" id="mediaInput_{{ inputName }}">
        
        <!-- Aperçu de l'image sélectionnée -->
        <div class="media-preview {% if not selectedMedia %}d-none{% endif %}" id="mediaPreview_{{ inputName }}">
            <div class="media-preview-container">
                {% if selectedMedia %}
                    <img src="/{{ selectedMedia.webPath }}" alt="{{ selectedMedia.alt }}" class="media-preview-image">
                {% endif %}
                <div class="media-preview-overlay">
                    <button type="button" class="btn btn-sm btn-outline-light me-2" onclick="openMediaLibrary('{{ inputName }}')">
                        <i class="bi bi-pencil"></i> Modifier
                    </button>
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeSelectedMedia('{{ inputName }}')">
                        <i class="bi bi-trash"></i> Supprimer
                    </button>
                </div>
            </div>
            {% if selectedMedia %}
                <div class="media-preview-info">
                    <small class="text-muted">{{ selectedMedia.alt ?: selectedMedia.fileName }}</small>
                </div>
            {% endif %}
        </div>
        
        <!-- Bouton de sélection (affiché quand aucune image n'est sélectionnée) -->
        <div class="media-selector-empty {% if selectedMedia %}d-none{% endif %}" id="mediaEmpty_{{ inputName }}">
            <button type="button" class="btn btn-outline-primary w-100" onclick="openMediaLibrary('{{ inputName }}')">
                <i class="bi bi-image me-2"></i>Sélectionner une image
            </button>
        </div>
    </div>
</div>

<!-- Modal de sélection de média -->
<div class="modal fade" id="mediaLibraryModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="bi bi-images me-2"></i>Bibliothèque de médias
                </h5>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Section d'upload multiple -->
                <div class="upload-section mb-4 p-3 border rounded bg-light">
                    <h6 class="mb-3">
                        <i class="bi bi-cloud-upload me-2"></i>Uploader de nouveaux médias
                    </h6>
                    <div class="upload-dropzone" id="uploadDropzone">
                        <input type="file" id="mediaUploadInput" multiple accept="image/*" style="display: none;">
                        <div class="upload-content text-center">
                            <i class="bi bi-cloud-upload text-primary" style="font-size: 2rem;"></i>
                            <p class="mb-2">Glissez vos images ici ou <button type="button" class="btn btn-link p-0" onclick="document.getElementById('mediaUploadInput').click()">cliquez pour parcourir</button></p>
                            <small class="text-muted">Formats acceptés: JPG, PNG, GIF, WebP</small>
                        </div>
                    </div>
                    
                    <!-- Progress bars pour les uploads -->
                    <div id="uploadProgress" class="mt-3" style="display: none;"></div>
                </div>
                
                <!-- Barre de recherche et filtres -->
                <div class="row mb-3">
                    <div class="col-md-8">
                        <input type="text" class="form-control" id="mediaLibrarySearch" placeholder="Rechercher un média...">
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="mediaLibraryTypeFilter">
                            <option value="">Tous les types</option>
                            <option value="image">Images</option>
                        </select>
                    </div>
                </div>
                
                <!-- Grille des médias -->
                <div id="mediaLibraryGrid" class="row g-3">
                    <!-- Les médias seront chargés ici -->
                </div>
                
                <!-- Pagination -->
                <div id="mediaLibraryPagination" class="d-flex justify-content-center mt-4">
                    <!-- Pagination sera générée ici -->
                </div>
                
                <!-- État vide -->
                <div id="mediaLibraryEmpty" class="text-center py-5" style="display: none;">
                    <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                    <h5 class="text-muted mt-3">Aucun média trouvé</h5>
                    <p class="text-muted">Essayez de modifier vos critères de recherche.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary">Fermer</button>
            </div>
        </div>
    </div>
</div>

<style>
.media-selector {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    min-height: 120px;
}

.media-preview-container {
    position: relative;
    display: inline-block;
    max-width: 100%;
}

.media-preview-image {
    max-width: 200px;
    max-height: 150px;
    object-fit: cover;
    border-radius: 0.375rem;
    display: block;
}

.media-preview-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.7);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
    border-radius: 0.375rem;
}

.media-preview-container:hover .media-preview-overlay {
    opacity: 1;
}

.media-preview {
    padding: 1rem;
    text-align: center;
}

.media-preview-info {
    margin-top: 0.5rem;
}

.media-selector-empty {
    padding: 2rem 1rem;
    text-align: center;
}

.media-library-item {
    position: relative;
    border: 2px solid transparent;
    border-radius: 0.375rem;
    overflow: hidden;
    cursor: pointer;
    transition: all 0.3s ease;
}

.media-library-item:hover {
    border-color: #0d6efd;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.media-library-item.selected {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.media-library-item img {
    width: 100%;
    height: 120px;
    object-fit: cover;
}

.media-library-item .media-library-overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(13, 110, 253, 0.8);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    transition: opacity 0.3s ease;
}

.media-library-item:hover .media-library-overlay,
.media-library-item.selected .media-library-overlay {
    opacity: 1;
}

.media-library-item .media-library-info {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: rgba(0,0,0,0.8);
    color: white;
    padding: 0.5rem;
    font-size: 0.8rem;
}

/* Styles pour la zone d'upload */
.upload-dropzone {
    border: 2px dashed #dee2e6;
    border-radius: 0.375rem;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-dropzone:hover,
.upload-dropzone.dragover {
    border-color: #0d6efd;
    background-color: #f8f9fa;
}

.upload-dropzone.dragover {
    border-color: #0d6efd;
    background-color: #e7f1ff;
}

.upload-progress-item {
    margin-bottom: 0.5rem;
}

.upload-progress-bar {
    transition: width 0.3s ease;
}

.upload-success {
    color: #198754;
}

.upload-error {
    color: #dc3545;
}
</style>

<script>
let mediaLibraryCurrentPage = 1;
let mediaLibrarySearchQuery = '';
let mediaLibraryTypeFilter = 'image'; // Par défaut, ne montrer que les images
let currentInputName = '';

function openMediaLibrary(inputName) {
    currentInputName = inputName;
    const modalElement = document.getElementById('mediaLibraryModal');
    
    // Réinitialiser les filtres
    document.getElementById('mediaLibrarySearch').value = '';
    document.getElementById('mediaLibraryTypeFilter').value = 'image';
    mediaLibraryCurrentPage = 1;
    mediaLibrarySearchQuery = '';
    mediaLibraryTypeFilter = 'image';
    
    // Charger les médias
    loadMediaLibrary();
    
    // Vérifier si Bootstrap est disponible
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
        // Fallback vers jQuery si Bootstrap n'est pas disponible
        $(modalElement).modal('show');
    } else {
        // Dernière solution : afficher manuellement
        modalElement.style.display = 'block';
        modalElement.classList.add('show');
        document.body.classList.add('modal-open');
        
        // Ajouter backdrop
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop fade show';
        backdrop.id = 'mediaModalBackdrop';
        document.body.appendChild(backdrop);
    }
}

function removeSelectedMedia(inputName) {
    document.getElementById('mediaInput_' + inputName).value = '';
    document.getElementById('mediaPreview_' + inputName).classList.add('d-none');
    document.getElementById('mediaEmpty_' + inputName).classList.remove('d-none');
}

function selectMedia(mediaId, mediaUrl, mediaAlt) {
    // Vérification de sécurité
    if (!currentInputName) {
        console.error('currentInputName is not defined');
        return;
    }
    
    // Mettre à jour le champ caché
    const hiddenInput = document.getElementById('mediaInput_' + currentInputName);
    if (hiddenInput) {
        hiddenInput.value = mediaId;
    }
    
    // Mettre à jour l'aperçu
    const previewContainer = document.getElementById('mediaPreview_' + currentInputName);
    const emptyContainer = document.getElementById('mediaEmpty_' + currentInputName);
    
    if (previewContainer && emptyContainer) {
        // Vérifier que les éléments enfants existent
        const previewImage = previewContainer.querySelector('.media-preview-image');
        const previewInfo = previewContainer.querySelector('.media-preview-info small');
        
        if (previewImage) {
            previewImage.src = mediaUrl;
            previewImage.alt = mediaAlt || '';
        }
        
        if (previewInfo) {
            previewInfo.textContent = mediaAlt || '';
        }
        
        previewContainer.classList.remove('d-none');
        emptyContainer.classList.add('d-none');
        
        // Fermer la modal
        closeMediaLibrary();
    } else {
        console.error('Preview containers not found for input:', currentInputName);
    }
}

function closeMediaLibrary() {
    const modalElement = document.getElementById('mediaLibraryModal');
    
    // Vérifier si Bootstrap est disponible
    if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    } else if (typeof $ !== 'undefined' && $.fn.modal) {
        // Fallback vers jQuery si Bootstrap n'est pas disponible
        $(modalElement).modal('hide');
    } else {
        // Dernière solution : cacher manuellement
        modalElement.style.display = 'none';
        modalElement.classList.remove('show');
        document.body.classList.remove('modal-open');
        
        // Supprimer backdrop
        const backdrop = document.getElementById('mediaModalBackdrop');
        if (backdrop) {
            backdrop.remove();
        }
    }
}

async function loadMediaLibrary() {
    try {
        const response = await fetch('{{ path("admin_media_list") }}?' + new URLSearchParams({
            page: mediaLibraryCurrentPage,
            search: mediaLibrarySearchQuery,
            type: mediaLibraryTypeFilter
        }));
        
        const data = await response.json();
        renderMediaLibrary(data.medias);
        renderMediaLibraryPagination(data.pagination);
    } catch (error) {
        console.error('Erreur lors du chargement des médias:', error);
    }
}

function renderMediaLibrary(medias) {
    const grid = document.getElementById('mediaLibraryGrid');
    const empty = document.getElementById('mediaLibraryEmpty');
    
    grid.innerHTML = '';
    
    if (medias.length === 0) {
        empty.style.display = 'block';
        return;
    }
    
    empty.style.display = 'none';
    
    medias.forEach(media => {
        if (media.isImage) { // Ne montrer que les images
            const item = createMediaLibraryItem(media);
            grid.appendChild(item);
        }
    });
}

function createMediaLibraryItem(media) {
    const col = document.createElement('div');
    col.className = 'col-lg-2 col-md-3 col-sm-4 col-6';
    
    col.innerHTML = `
        <div class="media-library-item" onclick="selectMedia(${media.id}, '${media.url}', '${media.alt || ''}')">
            <img src="${media.url}" alt="${media.alt || ''}">
            <div class="media-library-overlay">
                <i class="bi bi-check-circle" style="font-size: 2rem;"></i>
            </div>
            <div class="media-library-info">
                <div class="text-truncate">${media.alt || media.fileName}</div>
            </div>
        </div>
    `;
    
    return col;
}

function renderMediaLibraryPagination(pagination) {
    const container = document.getElementById('mediaLibraryPagination');
    container.innerHTML = '';
    
    if (pagination.total <= 1) return;
    
    const nav = document.createElement('nav');
    nav.innerHTML = '<ul class="pagination"></ul>';
    const ul = nav.querySelector('ul');
    
    // Page précédente
    if (pagination.current > 1) {
        ul.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToMediaLibraryPage(${pagination.current - 1}); return false;">Précédent</a>
            </li>
        `;
    }
    
    // Pages numérotées
    for (let i = Math.max(1, pagination.current - 2); i <= Math.min(pagination.total, pagination.current + 2); i++) {
        ul.innerHTML += `
            <li class="page-item ${i === pagination.current ? 'active' : ''}">
                <a class="page-link" href="#" onclick="goToMediaLibraryPage(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    // Page suivante
    if (pagination.current < pagination.total) {
        ul.innerHTML += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="goToMediaLibraryPage(${pagination.current + 1}); return false;">Suivant</a>
            </li>
        `;
    }
    
    container.appendChild(nav);
}

function goToMediaLibraryPage(page) {
    mediaLibraryCurrentPage = page;
    loadMediaLibrary();
}

// Fonctions pour l'upload multiple
function initializeUpload() {
    const uploadInput = document.getElementById('mediaUploadInput');
    const dropzone = document.getElementById('uploadDropzone');
    
    if (uploadInput) {
        uploadInput.addEventListener('change', handleFileSelection);
    }
    
    if (dropzone) {
        // Gestionnaires drag & drop
        dropzone.addEventListener('dragover', handleDragOver);
        dropzone.addEventListener('dragleave', handleDragLeave);
        dropzone.addEventListener('drop', handleFileDrop);
        dropzone.addEventListener('click', () => uploadInput.click());
    }
}

function handleDragOver(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.add('dragover');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('dragover');
}

function handleFileDrop(e) {
    e.preventDefault();
    e.stopPropagation();
    e.currentTarget.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    const imageFiles = files.filter(file => file.type.startsWith('image/'));
    
    if (imageFiles.length > 0) {
        uploadFiles(imageFiles);
    } else {
        alert('Veuillez sélectionner uniquement des fichiers image.');
    }
}

function handleFileSelection(e) {
    const files = Array.from(e.target.files);
    uploadFiles(files);
    // Réinitialiser l'input pour permettre la sélection du même fichier
    e.target.value = '';
}

async function uploadFiles(files) {
    const progressContainer = document.getElementById('uploadProgress');
    progressContainer.style.display = 'block';
    progressContainer.innerHTML = '';
    
    const formData = new FormData();
    
    // Ajouter tous les fichiers au FormData
    files.forEach((file, index) => {
        formData.append(`files[${index}]`, file);
        
        // Créer la barre de progression pour chaque fichier
        const progressItem = createProgressItem(file.name, index);
        progressContainer.appendChild(progressItem);
    });
    
    try {
        // Upload avec suivi de progression
        const response = await fetch('{{ path("admin_media_upload") }}', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Marquer tous les fichiers comme réussis
            files.forEach((file, index) => {
                updateProgressItem(index, 100, 'success', 'Upload réussi');
            });
            
            // Recharger la bibliothèque de médias
            setTimeout(() => {
                loadMediaLibrary();
                progressContainer.style.display = 'none';
            }, 2000);
        } else {
            // Gérer les erreurs individuelles si disponibles
            if (result.errors && Array.isArray(result.errors)) {
                result.errors.forEach((error, index) => {
                    updateProgressItem(index, 0, 'error', error);
                });
            } else {
                files.forEach((file, index) => {
                    updateProgressItem(index, 0, 'error', result.message || 'Erreur d\'upload');
                });
            }
        }
    } catch (error) {
        console.error('Erreur upload:', error);
        files.forEach((file, index) => {
            updateProgressItem(index, 0, 'error', 'Erreur réseau');
        });
    }
}

function createProgressItem(fileName, index) {
    const item = document.createElement('div');
    item.className = 'upload-progress-item';
    item.id = `progress-${index}`;
    
    item.innerHTML = `
        <div class="d-flex justify-content-between align-items-center mb-1">
            <small class="text-truncate" style="max-width: 70%;">${fileName}</small>
            <small class="upload-status">En cours...</small>
        </div>
        <div class="progress" style="height: 6px;">
            <div class="progress-bar upload-progress-bar" role="progressbar" style="width: 0%"></div>
        </div>
    `;
    
    return item;
}

function updateProgressItem(index, percentage, status, message) {
    const item = document.getElementById(`progress-${index}`);
    if (!item) return;
    
    const progressBar = item.querySelector('.upload-progress-bar');
    const statusElement = item.querySelector('.upload-status');
    
    if (progressBar) {
        progressBar.style.width = `${percentage}%`;
        
        // Changer la couleur selon le statut
        if (status === 'success') {
            progressBar.classList.remove('bg-danger');
            progressBar.classList.add('bg-success');
        } else if (status === 'error') {
            progressBar.classList.remove('bg-success');
            progressBar.classList.add('bg-danger');
        }
    }
    
    if (statusElement) {
        statusElement.textContent = message;
        statusElement.className = `upload-status ${status === 'success' ? 'upload-success' : status === 'error' ? 'upload-error' : ''}`;
    }
}

// Event listeners pour la recherche et les filtres
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('mediaLibrarySearch');
    const typeFilter = document.getElementById('mediaLibraryTypeFilter');
    
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            mediaLibrarySearchQuery = this.value;
            mediaLibraryCurrentPage = 1;
            loadMediaLibrary();
        });
    }
    
    if (typeFilter) {
        typeFilter.addEventListener('change', function() {
            mediaLibraryTypeFilter = this.value;
            mediaLibraryCurrentPage = 1;
            loadMediaLibrary();
        });
    }
    
    // Initialiser l'upload
    initializeUpload();
    
    // Gestionnaires pour fermer la modal
    const modalElement = document.getElementById('mediaLibraryModal');
    if (modalElement) {
        // Bouton de fermeture
        const closeButton = modalElement.querySelector('.btn-close');
        if (closeButton) {
            closeButton.addEventListener('click', closeMediaLibrary);
        }
        
        // Bouton Fermer dans le footer
        const footerCloseButton = modalElement.querySelector('.modal-footer .btn-secondary');
        if (footerCloseButton) {
            footerCloseButton.addEventListener('click', closeMediaLibrary);
        }
        
        // Clic sur le backdrop
        modalElement.addEventListener('click', function(e) {
            if (e.target === modalElement) {
                closeMediaLibrary();
            }
        });
        
        // Touche Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && !modalElement.classList.contains('d-none') && 
                (modalElement.style.display === 'block' || modalElement.classList.contains('show'))) {
                closeMediaLibrary();
            }
        });
    }
});
</script>