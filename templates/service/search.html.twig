{% extends 'base.html.twig' %}

{% block title %}{{ 'services.search_results'|trans({}, 'messages') }} - "{{ query }}" - Oragon{% endblock %}

{% block meta_description %}{{ 'services.search_meta_description'|trans({'%query%': query}, 'messages') }}{% endblock %}

{% block breadcrumb %}
<div class="bg-light py-3">
    <div class="container">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item">
                    <a href="{{ path('homepage', {'_locale': app.request.locale}) }}">
                        <i class="fas fa-home"></i> {{ 'navigation.home'|trans({}, 'messages') }}
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="{{ path('service_index', {'_locale': app.request.locale}) }}">
                        {{ 'services.title'|trans({}, 'messages') }}
                    </a>
                </li>
                <li class="breadcrumb-item active">{{ 'services.search_results'|trans({}, 'messages') }}</li>
            </ol>
        </nav>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- En-tête de recherche -->
    <div class="row mb-4">
        <div class="col-12 text-center">
            <h1 class="display-5 mb-3">
                <i class="fas fa-search me-2"></i>
                {{ 'services.search_results'|trans({}, 'messages') }}
            </h1>
            
            <p class="lead">
                {% if services|length > 0 %}
                    {{ 'services.search_found'|trans({'%count%': services|length, '%query%': query}, 'messages') }}
                {% else %}
                    {{ 'services.search_no_results'|trans({'%query%': query}, 'messages') }}
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Nouvelle recherche -->
    <div class="row mb-5">
        <div class="col-md-8 mx-auto">
            <form method="get" action="{{ path('service_search', {'_locale': app.request.locale}) }}" class="card">
                <div class="card-body">
                    <div class="input-group">
                        <input type="text" name="q" class="form-control form-control-lg" 
                               placeholder="{{ 'services.search_placeholder'|trans({}, 'messages') }}"
                               value="{{ query }}"
                               autofocus>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-search me-1"></i>
                            {{ 'services.search_button'|trans({}, 'messages') }}
                        </button>
                    </div>
                    
                    <div class="mt-3 text-center">
                        <a href="{{ path('service_index', {'_locale': app.request.locale}) }}" class="btn btn-link">
                            {{ 'services.view_all'|trans({}, 'messages') }}
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Résultats de la recherche -->
    {% if services|length > 0 %}
        <div class="row">
            {% for service in services %}
                {% set hasTranslation = service.getTranslation(app.request.locale) %}
                {% set isTranslationComplete = hasTranslation ? hasTranslation.isComplete : false %}
                
                <div class="col-lg-6 mb-4">
                    <div class="card service-card h-100">
                        <div class="row g-0 h-100">
                            <!-- Image -->
                            <div class="col-md-4">
                                {% if service.image %}
                                    <img src="{{ asset('upload/media/' ~ service.image.fileName) }}" 
                                         class="img-fluid h-100 rounded-start" 
                                         alt="{{ service.image.alt }}"
                                         style="object-fit: cover;">
                                {% else %}
                                    <div class="h-100 d-flex align-items-center justify-content-center bg-primary text-white rounded-start">
                                        <i class="fas fa-cogs fa-2x"></i>
                                    </div>
                                {% endif %}
                            </div>
                            
                            <!-- Contenu -->
                            <div class="col-md-8">
                                <div class="card-body d-flex flex-column h-100">
                                    <!-- Alerte si traduction incomplète -->
                                    {% if not isTranslationComplete %}
                                        <div class="alert alert-warning alert-sm mb-2">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            <small>{{ 'services.translation_incomplete'|trans({}, 'messages') }}</small>
                                        </div>
                                    {% endif %}

                                    <h5 class="card-title">
                                        {{ service.title ?? service.slug }}
                                    </h5>
                                    
                                    {% if service.description %}
                                        <p class="card-text flex-grow-1">
                                            {% set highlighted_description = service.description|replace({(query): '<mark>' ~ query ~ '</mark>'})|raw %}
                                            {{ highlighted_description|slice(0, 120) }}
                                            {% if service.description|length > 120 %}...{% endif %}
                                        </p>
                                    {% endif %}

                                    <div class="mt-auto">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <a href="{{ path('service_show', {'_locale': app.request.locale, 'slug': service.slug}) }}" 
                                               class="btn btn-primary btn-sm">
                                                {{ 'services.read_more'|trans({}, 'messages') }}
                                                <i class="fas fa-arrow-right ms-1"></i>
                                            </a>
                                            
                                            <!-- Indicateurs de langue -->
                                            <div>
                                                {% for locale in service.availableLocales %}
                                                    {% set localeService = service.getTranslation(locale) %}
                                                    {% if localeService and localeService.isComplete %}
                                                        <span class="badge bg-success me-1" style="font-size: 0.6em;">
                                                            {{ locale|upper }}
                                                        </span>
                                                    {% endif %}
                                                {% endfor %}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>

        <!-- Informations supplémentaires -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <i class="fas fa-info-circle me-2"></i>
                            {{ 'services.search_tip'|trans({}, 'messages') }}
                        </div>
                        <div class="col-md-4 text-md-end">
                            <small class="text-muted">
                                {{ 'services.results_in_language'|trans({'%language%': current_language.name}, 'messages') }}
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Aucun résultat -->
        <div class="row">
            <div class="col-12 text-center py-5">
                <div class="mb-4">
                    <i class="fas fa-search-minus fa-4x text-muted mb-3"></i>
                    <h3 class="text-muted">{{ 'services.no_results_title'|trans({}, 'messages') }}</h3>
                </div>
                
                <div class="alert alert-light d-inline-block">
                    <h6>{{ 'services.search_suggestions_title'|trans({}, 'messages') }}</h6>
                    <ul class="list-unstyled mb-0 text-start">
                        <li><i class="fas fa-check text-success me-2"></i>{{ 'services.search_suggestion_1'|trans({}, 'messages') }}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{{ 'services.search_suggestion_2'|trans({}, 'messages') }}</li>
                        <li><i class="fas fa-check text-success me-2"></i>{{ 'services.search_suggestion_3'|trans({}, 'messages') }}</li>
                    </ul>
                </div>

                <div class="mt-4">
                    <a href="{{ path('service_index', {'_locale': app.request.locale}) }}" class="btn btn-primary me-2">
                        <i class="fas fa-th-list me-1"></i>
                        {{ 'services.browse_all'|trans({}, 'messages') }}
                    </a>
                    
                    <!-- Recherches suggérées -->
                    <div class="mt-3">
                        <small class="text-muted">{{ 'services.try_searching'|trans({}, 'messages') }}:</small><br>
                        {% set suggested_searches = ['web', 'mobile', 'marketing', 'design'] %}
                        {% for suggestion in suggested_searches %}
                            <a href="{{ path('service_search', {'_locale': app.request.locale, 'q': suggestion}) }}" 
                               class="btn btn-outline-secondary btn-sm me-1 mt-1">
                                {{ suggestion }}
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <!-- Retour à la liste complète -->
    <div class="row mt-5">
        <div class="col-12 text-center">
            <hr>
            <a href="{{ path('service_index', {'_locale': app.request.locale}) }}" class="btn btn-outline-primary">
                <i class="fas fa-arrow-left me-1"></i>
                {{ 'services.back_to_all'|trans({}, 'messages') }}
            </a>
        </div>
    </div>
</div>

<style>
.service-card {
    transition: transform 0.2s ease, box-shadow 0.2s ease;
    border: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.service-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
}

.alert-sm {
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
}

mark {
    background-color: #fff3cd;
    padding: 0.1em 0.2em;
    border-radius: 0.2em;
}

.badge {
    font-size: 0.6em;
}

@media (max-width: 768px) {
    .display-5 {
        font-size: 1.8rem;
    }
    
    .service-card .row {
        flex-direction: column;
    }
    
    .service-card .col-md-4 img,
    .service-card .col-md-4 div {
        height: 150px !important;
    }
}
</style>

<script>
// Mettre en évidence les termes de recherche
document.addEventListener('DOMContentLoaded', function() {
    const query = '{{ query|escape('js') }}';
    if (query.length > 2) {
        // Highlight des termes dans le contenu (simple implémentation)
        const regex = new RegExp(`(${query})`, 'gi');
        const textNodes = document.querySelectorAll('.card-text');
        
        textNodes.forEach(node => {
            if (node.textContent.toLowerCase().includes(query.toLowerCase())) {
                node.innerHTML = node.innerHTML.replace(regex, '<mark>$1</mark>');
            }
        });
    }
});
</script>
{% endblock %}
