{% extends 'base.html.twig' %}

{% block title %}Oragon - Services multilingues{% endblock %}

{% block body %}
<div class="container my-5">
    {# Hero section #}
    <div class="row">
        <div class="col-12">
            <div class="text-center mb-5">
                <h1 class="display-4 fw-bold mb-3">
                    <i class="bi bi-hexagon-fill text-primary me-3"></i>
                    Bienvenue sur Oragon
                </h1>
                <p class="lead text-muted">
                    Découvrez nos services disponibles en plusieurs langues
                </p>
            </div>
        </div>
    </div>
    
    {# Language selector and search #}
    {% if languages|length > 1 %}
        <div class="row mb-4">
            <div class="col-md-6 offset-md-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-sm-6">
                                <label for="languageSelect" class="form-label mb-1">
                                    <i class="bi bi-globe me-1"></i>Langue d'affichage
                                </label>
                                <select id="languageSelect" class="form-select" 
                                        onchange="switchLanguage(this.value)">
                                    {% for language in languages %}
                                        <option value="{{ language.code }}" 
                                                {% if currentLanguage and currentLanguage.code == language.code %}selected{% endif %}>
                                            {{ language.nativeName }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-sm-6">
                                <label for="searchInput" class="form-label mb-1">
                                    <i class="bi bi-search me-1"></i>Rechercher
                                </label>
                                <div class="input-group">
                                    <input type="text" id="searchInput" class="form-control" 
                                           placeholder="Rechercher un service..." 
                                           onkeyup="searchServices(this.value)">
                                    <button class="btn btn-outline-secondary" type="button" 
                                            onclick="document.getElementById('searchInput').value = ''; searchServices('')">
                                        <i class="bi bi-x-lg"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}
    
    {# Services grid #}
    <div class="row" id="servicesContainer">
        {% if services|length > 0 %}
            {% for service in services %}
                {% if service.active %}
                    {% set defaultLanguage = languages|first %}
                    {% for language in languages %}
                        {% if language.default %}
                            {% set defaultLanguage = language %}
                        {% endif %}
                    {% endfor %}
                    
                    {% set translation = service.getTranslationForLanguage(currentLanguage) %}
                    {% if not translation or not translation.title %}
                        {% set translation = service.getTranslationForLanguage(defaultLanguage) %}
                    {% endif %}
                    
                    <div class="col-lg-4 col-md-6 mb-4 service-item" data-service-id="{{ service.id }}">
                        <div class="card h-100 service-card">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">
                                    <i class="bi bi-gear-fill text-primary me-2"></i>
                                    {{ translation ? translation.title : service.slug }}
                                </h5>
                                {% if translation and translation.description %}
                                    <p class="card-text flex-grow-1">{{ translation.description }}</p>
                                {% endif %}
                                <div class="mt-auto">
                                    <a href="{{ path('service_show', {slug: service.slug}) }}" 
                                       class="btn btn-primary">
                                        <i class="bi bi-arrow-right me-2"></i>En savoir plus
                                    </a>
                                </div>
                            </div>
                            {% if translation and translation.language != currentLanguage %}
                                <div class="card-footer bg-warning text-dark">
                                    <small>
                                        <i class="bi bi-info-circle me-1"></i>
                                        Affiché en {{ translation.language.nativeName }}
                                    </small>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            {% endfor %}
        {% else %}
            <div class="col-12">
                <div class="text-center py-5">
                    <i class="bi bi-inbox display-1 text-muted mb-4"></i>
                    <h4 class="text-muted mb-3">Aucun service disponible</h4>
                    <p class="text-muted">Revenez bientôt pour découvrir nos services.</p>
                </div>
            </div>
        {% endif %}
    </div>
    
    {# No results message (hidden by default) #}
    <div id="noResults" class="row d-none">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="bi bi-search display-1 text-muted mb-4"></i>
                <h4 class="text-muted mb-3">Aucun résultat trouvé</h4>
                <p class="text-muted">Essayez avec d'autres mots-clés.</p>
                <button class="btn btn-outline-primary" onclick="clearSearch()">
                    <i class="bi bi-arrow-counterclockwise me-2"></i>Effacer la recherche
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_javascripts %}
    {{ parent() }}
    <script>
        // Search functionality
        function searchServices(query) {
            const serviceItems = document.querySelectorAll('.service-item');
            const noResults = document.getElementById('noResults');
            let visibleCount = 0;
            
            query = query.toLowerCase().trim();
            
            serviceItems.forEach(function(item) {
                const title = item.querySelector('.card-title').textContent.toLowerCase();
                const description = item.querySelector('.card-text');
                const descText = description ? description.textContent.toLowerCase() : '';
                
                if (query === '' || title.includes(query) || descText.includes(query)) {
                    item.classList.remove('d-none');
                    visibleCount++;
                } else {
                    item.classList.add('d-none');
                }
            });
            
            if (visibleCount === 0 && query !== '') {
                noResults.classList.remove('d-none');
            } else {
                noResults.classList.add('d-none');
            }
        }
        
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            searchServices('');
        }
        
        // Language switching with page reload
        function switchLanguage(languageCode) {
            // Store the selected language and reload
            sessionStorage.setItem('selectedLanguage', languageCode);
            
            axios.post(`/api/switch-language/${languageCode}`)
                .then(response => {
                    if (response.data.success) {
                        window.location.reload();
                    }
                })
                .catch(error => {
                    console.error('Erreur lors du changement de langue:', error);
                    // Fallback: reload anyway
                    window.location.reload();
                });
        }
        
        // Restore language selection on page load
        document.addEventListener('DOMContentLoaded', function() {
            const savedLanguage = sessionStorage.getItem('selectedLanguage');
            const languageSelect = document.getElementById('languageSelect');
            
            if (savedLanguage && languageSelect) {
                languageSelect.value = savedLanguage;
            }
        });
    </script>
{% endblock %}